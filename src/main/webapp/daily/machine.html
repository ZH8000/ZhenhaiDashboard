<div data-lift="Surround?with=default;at=content">
  <div class="center aligned one column ui grid" data-lift="DailyReport.machine">
    <div class="column">
      <div class="ui four steps">
        <a href="javascript: void(0)" class="ui step">Step Title</a>
      </div>
    </div>
    <div class="column">
      <a id="csvURL" href="javascript: void(0)" class="ui right floated primary button">Export CSV File</a>
    </div>
    <div class="ui grid">

      <div class="six wide column">
        <div id="datepicker"></div>
        <div class="ui vertical menu">
          <div class="header item">機器列表</div>
          <div class="item">
            <select id="machineList" data-lift="MachineList">
              <option>MachineID</option>
            </select>
          </div>
        </div>
      </div>

      <div class="ten wide column data">
        <div class="ui center aligned one column grid" id="loadingIndicator">
          <div class="column">
            <div data-lift="embed?what=loading"></div>
          </div>
        </div>
        <div class="ui one column page hidden grid" id="notFoundBlock">
          <div class="column">
            <div class="ui icon error message">
              <i class="inbox icon"></i>
              <div class="content">
                <div class="header">查無資料</div>
                <p>無法查詢到相關資料，請確定是否選擇了正確的日期與機器。</p>
              </div>
            </div>
          </div>
        </div>

        <div class="ui center aligned two column hidden grid data">

          <div class="column">
            <div class="container detailBarChart">
              <svg class="barChart"></svg>
            </div>
          </div>

          <div class="column"><svg class="pieChart"></svg></div>
        </div>
        <div class="hidden grid data">
          <div data-lift="LazyLoad?template=loading">
            <div data-lift="DailyReport.summary">
              <h3 class="ui dividing header">統計資料</h3>
              <div style="float: right; padding-bottom: 1em;">
                生產均線：<span class="levelA">LevelA</span> / <span class="levelB">LevelB</span> / <span class="levelC">LevelC</span>
              </div>
              <table class="ui celled table segment">
                <thead>
                  <tr>
                    <th>事件</th>
                    <th>數量</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>良品數</td><td><span class="countQty">12345</span> <span class="ui label">Level</span></td></tr>
                  <tr class="eventRow"><td class="eventName">EventName</td><td class="eventCount">67890</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <h3 class="ui dividing header">詳細資料</h3>
          <table class="ui celled table segment">
            <thead>
              <tr>
                <th>時間</th>
                <th>良品數量</th>
                <th>事件數量</th>
                <th>事件類別</th>
              </tr>
            </thead>
            <tbody id="table"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div>
      <input type="hidden" id="step" />
      <input type="hidden" id="productMachine" />
      <input type="hidden" id="fullYear" />
      <input type="hidden" id="month" />
      <input type="hidden" id="date" />
      <input type="hidden" id="dataURL" />
    </div>
    <script>
      
      var productMachine = $('#productMachine').val()
      var fullYear = +($('#fullYear').val())
      var month = +($('#month').val())
      var date = +($('#date').val())
      var dataURL = $('#dataURL').val()
      var step = $('#step').val();

      $("#datepicker").datepicker({
        firstDay: 0,
        onSelect: function(dateText, inst) {

          function strToDate(dateString) {
            var columns = dateString.split("/");
            return new Date(columns[0], +(columns[1]-1), columns[2]);
          }

          function getWeek(isoDate) {
            var date = isoDate.getDate();
            var day = isoDate.getDay();
            return Math.ceil((date - 1 - day) / 7) + 1;
          }

          var isoDate = strToDate(dateText);

          var url = "/daily/" + isoDate.getFullYear() + "/" + (+isoDate.getMonth()+1) + "/" + step + 
                    "/" + isoDate.getDate() + "/" + productMachine;

          window.location = url;
        }
      });

      $("#datepicker").datepicker("setDate", new Date(fullYear, (+month - 1), date ));
      $("#datepicker").datepicker("option", "dateFormat", "yy/mm/dd");

      setupMachineList('#machineList', productMachine, "/daily/" + fullYear + "/" + month + "/" + step + "/" + date);

    </script>
    <script>
      $(function() {

        function toPieChartData(dataJSON) {
          var data = {};
         
          function addToData(name, value) {
            if (data[name]) {
              data[name] = (+(data[name]) + value)
            } else {
              data[name] = +value
            } 
          } 

          for (var i = 0; i < dataJSON.length; i++) {
            if (+(dataJSON[i].event_qty > 0)) {
              addToData(dataJSON[i].defact_id, dataJSON[i].event_qty);
            }
          }

          var pieChartData = [];
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            pieChartData.push({
              label: keys[i],
              value: data[keys[i]]
            });
          }

          return pieChartData;
        }

        function toBarChartData(dataJSON) {
          var data = {};
         
          function addToData(name, value) {
            if (data[name]) {
              data[name] = (+(data[name]) + value)
            } else {
              data[name] = +value
            } 
          } 

          for (var i = 0; i < dataJSON.length; i++) {
            var hours = dataJSON[i].timestamp.substring(11, 13);
            addToData(hours + ":00", dataJSON[i].count_qty);
          }

          var barChartData = [];
          var keys = Object.keys(data)
          for (var i = 0; i < keys.length; i++) {
            barChartData.push({
              time: keys[i],
              qty: data[keys[i]]
            });
          }

          return barChartData;
        }


        function toTableSchema(dataJSON) {
          return {
            data: dataJSON.dataSet,
            extractors: [
              function (data) { return data.timestamp },
              function (data) { return data.count_qty == 0 ? "" : data.count_qty; },
              function (data) { return data.event_qty == 0 ? "" : data.event_qty; },
              function (data) { return data.count_qty > 0 ? "" : data.defact_id; }
            ]
          }
        }

        $.ajax(dataURL, {timeout: 30 * 1000}).done(function(data) {

          if (!data.dataSet || data.dataSet.length == 0) {
            $('#notFoundBlock').show();
            return;
          }

          if (data.steps) { 
            setStepsTitle("step", data.steps) 
          }

          setTable("#table", toTableSchema(data));

          var drawPieChart = pieChart({
            width: 250,
            height: 250,
            radius: 100,
            extractValue: function(data) { return data.value; },
            extractName: function(data) { return data.label; }
          })

          drawPieChart(".pieChart", toPieChartData(data.dataSet));

          var drawBarChart = barChart({
            totalHeight: 300,
            barWidth: 50,
            barPadding: 20,
            topMargin: 20,
            bottomMargin: 20,
            extractValue: function(data) { return data.qty },
            extractName: function(data) { return data.time }
          })

          drawBarChart(".barChart", toBarChartData(data.dataSet));

          $(".data").show();

        }).error(function() {
          $('#notFoundBlock').show();
        }).always(function() {
          $("#loadingIndicator").hide();

        });
      });
    </script>
  </div>
</div>
